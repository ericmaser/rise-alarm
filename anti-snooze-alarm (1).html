<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rise ‚Äî Anti-Snooze Alarm</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;1,400;1,500&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #faf7f2;
    --cream2: #f3ede3;
    --cream3: #ede5d8;
    --peach: #f0876a;
    --peach-light: #f9c4b2;
    --peach-pale: #fdf0eb;
    --sage: #7a9e87;
    --sage-light: #b8d4c0;
    --sage-pale: #eef5f0;
    --terracotta: #c96b4a;
    --amber: #e8a045;
    --amber-pale: #fdf3e3;
    --text: #2d2416;
    --text-mid: #7a6a55;
    --text-light: #b5a690;
    --white: #ffffff;
    --shadow-sm: 0 2px 12px rgba(45,36,22,0.07);
    --shadow-md: 0 8px 32px rgba(45,36,22,0.10);
    --shadow-lg: 0 20px 60px rgba(45,36,22,0.14);
    --radius: 20px;
    --radius-sm: 12px;
    --serif: 'Lora', Georgia, serif;
    --sans: 'Nunito', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--cream);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 80% 60% at 15% 10%, rgba(240,135,106,0.12) 0%, transparent 60%),
      radial-gradient(ellipse 60% 50% at 85% 90%, rgba(122,158,135,0.10) 0%, transparent 55%),
      radial-gradient(ellipse 50% 40% at 50% 50%, rgba(232,160,69,0.06) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  /* ‚îÄ‚îÄ SETUP SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #setup-screen {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem 1.5rem;
    position: relative;
    z-index: 1;
  }

  .app-wordmark {
    font-family: var(--serif);
    font-size: 1.6rem;
    font-weight: 400;
    color: var(--peach);
    letter-spacing: 0.04em;
    margin-bottom: 2.5rem;
    text-align: center;
  }

  .app-wordmark span {
    color: var(--text-light);
    font-size: 0.72rem;
    font-family: var(--sans);
    font-weight: 600;
    letter-spacing: 0.14em;
    display: block;
    text-align: center;
    margin-top: 3px;
    text-transform: uppercase;
  }

  /* Breathing clock orb */
  .clock-orb-wrap {
    position: relative;
    width: 200px; height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1.25rem;
  }

  .orb-ring {
    position: absolute;
    border-radius: 50%;
    border: 1.5px solid rgba(240,135,106,0.15);
    animation: breathe 4s ease-in-out infinite;
  }

  .orb-ring:nth-child(1) { width: 200px; height: 200px; }
  .orb-ring:nth-child(2) { width: 160px; height: 160px; animation-delay: 0.3s; border-color: rgba(240,135,106,0.22); }
  .orb-ring:nth-child(3) { width: 120px; height: 120px; animation-delay: 0.6s; border-color: rgba(240,135,106,0.30); }

  .orb-core {
    width: 88px; height: 88px;
    background: linear-gradient(135deg, var(--peach-light) 0%, var(--peach) 100%);
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 24px rgba(240,135,106,0.35), inset 0 1px 0 rgba(255,255,255,0.3);
    animation: breathe 4s ease-in-out infinite;
    position: relative;
    z-index: 1;
  }

  @keyframes breathe {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.06); }
  }

  .clock-display {
    font-family: var(--sans);
    font-size: 1.05rem;
    font-weight: 700;
    color: white;
    letter-spacing: 0.05em;
    line-height: 1;
  }

  .clock-ampm {
    font-size: 0.5rem;
    font-weight: 700;
    color: rgba(255,255,255,0.7);
    letter-spacing: 0.12em;
    margin-top: 3px;
  }

  .clock-date-label {
    font-size: 0.8rem;
    color: var(--text-light);
    font-weight: 500;
    text-align: center;
    margin-bottom: 2rem;
  }

  /* Setup card */
  .setup-card {
    background: var(--white);
    border-radius: var(--radius);
    padding: 2rem;
    width: 100%;
    max-width: 420px;
    box-shadow: var(--shadow-md);
  }

  .success-banner {
    background: var(--sage-pale);
    border: 1.5px solid var(--sage-light);
    border-radius: var(--radius-sm);
    color: var(--sage);
    padding: 0.875rem 1.25rem;
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    display: none;
    align-items: center;
    gap: 0.5rem;
  }

  .field-group { margin-bottom: 1.5rem; }

  .field-label {
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-light);
    margin-bottom: 0.5rem;
    display: block;
  }

  .time-input {
    width: 100%;
    background: var(--cream);
    border: 1.5px solid var(--cream3);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: var(--sans);
    font-size: 2rem;
    font-weight: 700;
    padding: 0.875rem 1.25rem;
    text-align: center;
    letter-spacing: 0.05em;
    outline: none;
    transition: border-color 0.2s, background 0.2s;
    -webkit-appearance: none;
  }

  .time-input:focus {
    border-color: var(--peach);
    background: var(--peach-pale);
  }

  .toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.25rem 0;
    border-top: 1.5px solid var(--cream2);
    border-bottom: 1.5px solid var(--cream2);
    margin-bottom: 1.5rem;
  }

  .toggle-name {
    font-weight: 700;
    font-size: 1rem;
    color: var(--text);
    margin-bottom: 2px;
  }

  .toggle-sub {
    font-size: 0.78rem;
    color: var(--text-light);
  }

  .pill-toggle {
    width: 52px; height: 30px;
    background: var(--cream3);
    border-radius: 15px;
    position: relative;
    cursor: pointer;
    transition: background 0.25s;
    flex-shrink: 0;
    border: none;
    outline: none;
  }

  .pill-toggle.on { background: var(--peach); }

  .pill-toggle::after {
    content: '';
    position: absolute;
    top: 3px; left: 3px;
    width: 24px; height: 24px;
    background: white;
    border-radius: 50%;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    transition: transform 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .pill-toggle.on::after { transform: translateX(22px); }

  .next-alarm-chip {
    background: var(--amber-pale);
    border-radius: var(--radius-sm);
    padding: 0.75rem 1rem;
    font-size: 0.82rem;
    color: var(--amber);
    font-weight: 600;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .btn {
    width: 100%;
    padding: 0.9rem 1.5rem;
    font-family: var(--sans);
    font-size: 0.95rem;
    font-weight: 700;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.34, 1.2, 0.64, 1);
    margin-bottom: 0.625rem;
    letter-spacing: 0.02em;
  }

  .btn:active { transform: scale(0.97); }

  .btn-primary {
    background: linear-gradient(135deg, var(--peach) 0%, var(--terracotta) 100%);
    color: white;
    box-shadow: 0 4px 16px rgba(201,107,74,0.30);
  }

  .btn-primary:hover {
    box-shadow: 0 6px 20px rgba(201,107,74,0.42);
    transform: translateY(-1px);
  }

  .btn-secondary {
    background: var(--cream);
    color: var(--text-mid);
    border: 1.5px solid var(--cream3);
  }

  .btn-secondary:hover { background: var(--cream2); }

  .btn-success {
    background: linear-gradient(135deg, var(--sage) 0%, #5a8a6a 100%);
    color: white;
    box-shadow: 0 4px 16px rgba(122,158,135,0.35);
  }

  .btn-success:hover {
    box-shadow: 0 6px 20px rgba(122,158,135,0.48);
    transform: translateY(-1px);
  }

  .btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
  }

  /* ‚îÄ‚îÄ ALARM OVERLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #alarm-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: var(--cream);
    z-index: 1000;
    flex-direction: column;
    overflow-y: auto;
  }

  #alarm-overlay.active { display: flex; }

  #alarm-overlay::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 70% 50% at 20% 5%, rgba(240,135,106,0.16) 0%, transparent 55%),
      radial-gradient(ellipse 50% 40% at 80% 95%, rgba(122,158,135,0.10) 0%, transparent 50%);
    pointer-events: none;
    animation: ambientShift 8s ease-in-out infinite alternate;
  }

  @keyframes ambientShift {
    0% { opacity: 0.6; }
    100% { opacity: 1; }
  }

  /* Topbar */
  .alarm-topbar {
    position: sticky;
    top: 0;
    z-index: 10;
    padding: 1rem 1.5rem;
    background: rgba(250,247,242,0.88);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    border-bottom: 1px solid rgba(240,135,106,0.12);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }

  .alarm-pill {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--peach-pale);
    border: 1.5px solid var(--peach-light);
    border-radius: 50px;
    padding: 0.4rem 1rem;
    font-size: 0.78rem;
    font-weight: 700;
    color: var(--terracotta);
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }

  .alarm-dot {
    width: 7px; height: 7px;
    background: var(--peach);
    border-radius: 50%;
    animation: gentlePulse 2s ease-in-out infinite;
  }

  @keyframes gentlePulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.4; transform: scale(0.8); }
  }

  .sound-badge {
    font-size: 0.72rem;
    font-weight: 600;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .sound-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--cream3);
    transition: background 0.3s;
  }

  .sound-dot.playing {
    background: var(--peach);
    animation: gentlePulse 0.8s ease-in-out infinite;
  }

  /* Step indicators */
  .step-track {
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .step-seg {
    height: 3px; width: 40px;
    border-radius: 2px;
    background: var(--cream3);
    transition: background 0.4s ease;
  }

  .step-seg.active { background: var(--peach-light); }
  .step-seg.done { background: var(--sage); }

  /* Main content */
  .alarm-content {
    flex: 1;
    padding: 2rem 1.5rem 5rem;
    max-width: 640px;
    margin: 0 auto;
    width: 100%;
    position: relative;
    z-index: 1;
  }

  /* Inactivity toast */
  .inactivity-toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: white;
    border-radius: 50px;
    padding: 0.75rem 1.5rem;
    box-shadow: var(--shadow-lg);
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--amber);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    z-index: 1001;
    transition: transform 0.4s cubic-bezier(0.34, 1.2, 0.64, 1);
    white-space: nowrap;
  }

  .inactivity-toast.show { transform: translateX(-50%) translateY(0); }

  /* ‚îÄ‚îÄ READING STEP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .eyebrow {
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    color: var(--peach);
    margin-bottom: 0.75rem;
    margin-top: 2rem;
  }

  .eyebrow.sage { color: var(--sage); }

  .passage-title {
    font-family: var(--serif);
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    font-weight: 500;
    color: var(--text);
    line-height: 1.15;
    margin-bottom: 0.5rem;
  }

  .passage-subtitle {
    font-size: 0.9rem;
    color: var(--text-light);
    font-style: italic;
    font-family: var(--serif);
    margin-bottom: 2rem;
  }

  .passage-body {
    font-size: 1.05rem;
    line-height: 1.85;
    color: var(--text-mid);
  }

  .passage-body p { margin-bottom: 1.25rem; }

  /* Dwell */
  .dwell-section {
    margin-top: 2.5rem;
    background: white;
    border-radius: var(--radius);
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
  }

  .dwell-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.875rem;
  }

  .dwell-label {
    font-size: 0.78rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-light);
  }

  .dwell-timer {
    font-size: 0.82rem;
    font-weight: 700;
    color: var(--amber);
  }

  .dwell-track {
    background: var(--cream2);
    border-radius: 4px;
    height: 5px;
    overflow: hidden;
    margin-bottom: 1.25rem;
  }

  .dwell-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--peach-light), var(--peach));
    border-radius: 4px;
    width: 0%;
    transition: width 0.8s ease;
  }

  .dwell-fill.complete {
    background: linear-gradient(90deg, var(--sage-light), var(--sage));
  }

  /* ‚îÄ‚îÄ QUIZ STEP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .quiz-headline {
    font-family: var(--serif);
    font-size: clamp(1.5rem, 3.5vw, 2.25rem);
    font-weight: 500;
    color: var(--text);
    margin-bottom: 0.5rem;
  }

  .quiz-sub {
    font-size: 0.88rem;
    color: var(--text-light);
    font-style: italic;
    font-family: var(--serif);
    margin-bottom: 2rem;
  }

  .result-card {
    border-radius: var(--radius-sm);
    padding: 1.25rem 1.5rem;
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
    font-weight: 600;
    display: none;
    align-items: center;
    gap: 0.75rem;
  }

  .result-card.pass {
    background: var(--sage-pale);
    border: 1.5px solid var(--sage-light);
    color: var(--sage);
    display: flex;
  }

  .result-card.fail {
    background: var(--peach-pale);
    border: 1.5px solid var(--peach-light);
    color: var(--terracotta);
    display: flex;
  }

  .result-icon { font-size: 1.5rem; flex-shrink: 0; }

  .question-card {
    background: white;
    border-radius: var(--radius);
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: var(--shadow-sm);
    border: 1.5px solid transparent;
    transition: border-color 0.3s;
  }

  .question-card.correct { border-color: var(--sage-light); }
  .question-card.incorrect { border-color: var(--peach-light); }

  .question-num {
    font-size: 0.68rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-light);
    margin-bottom: 0.625rem;
  }

  .question-prompt {
    font-family: var(--serif);
    font-size: 1rem;
    font-weight: 500;
    color: var(--text);
    line-height: 1.5;
    margin-bottom: 1.125rem;
  }

  .option-btn {
    display: flex;
    align-items: center;
    width: 100%;
    text-align: left;
    background: var(--cream);
    border: 1.5px solid var(--cream3);
    color: var(--text-mid);
    padding: 0.7rem 1rem;
    margin-bottom: 0.5rem;
    font-family: var(--sans);
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.18s;
    border-radius: var(--radius-sm);
    font-weight: 500;
    line-height: 1.4;
    gap: 0.75rem;
  }

  .option-letter {
    width: 24px; height: 24px;
    border-radius: 50%;
    background: var(--cream3);
    display: flex; align-items: center; justify-content: center;
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--text-light);
    flex-shrink: 0;
    transition: all 0.18s;
  }

  .option-btn:hover:not(:disabled) {
    border-color: var(--peach-light);
    background: var(--peach-pale);
  }

  .option-btn:hover:not(:disabled) .option-letter {
    background: var(--peach-light);
    color: var(--terracotta);
  }

  .option-btn.selected { border-color: var(--peach); background: var(--peach-pale); }
  .option-btn.selected .option-letter { background: var(--peach); color: white; }

  .option-btn.correct-ans { border-color: var(--sage); background: var(--sage-pale); color: var(--sage); }
  .option-btn.correct-ans .option-letter { background: var(--sage); color: white; }

  .option-btn.wrong-ans { border-color: var(--peach); background: var(--peach-pale); color: var(--terracotta); opacity: 0.7; }
  .option-btn:disabled { cursor: default; }

  /* ‚îÄ‚îÄ DEV PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #dev-panel {
    position: fixed;
    bottom: 1rem; right: 1rem;
    background: rgba(250,247,242,0.96);
    border: 1px solid var(--cream3);
    border-radius: var(--radius-sm);
    padding: 1rem;
    font-family: 'Courier New', monospace;
    font-size: 0.7rem;
    color: var(--text-mid);
    z-index: 9999;
    min-width: 220px;
    box-shadow: var(--shadow-md);
    display: none;
  }

  #dev-panel h4 {
    color: var(--peach);
    letter-spacing: 0.15em;
    margin-bottom: 0.625rem;
    font-size: 0.68rem;
    text-transform: uppercase;
  }

  .dev-row {
    display: flex;
    justify-content: space-between;
    padding: 0.2rem 0;
    border-bottom: 1px solid var(--cream2);
    gap: 1rem;
  }

  .dev-val { color: var(--sage); font-weight: 600; }
  .dev-val.warm { color: var(--peach); }
  .dev-val.amber { color: var(--amber); }

  #dev-toggle {
    position: fixed;
    bottom: 1rem; left: 1rem;
    background: white;
    border: 1px solid var(--cream3);
    border-radius: 50px;
    color: var(--text-light);
    font-family: var(--sans);
    font-size: 0.7rem;
    font-weight: 700;
    padding: 0.4rem 0.875rem;
    cursor: pointer;
    z-index: 9999;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    box-shadow: var(--shadow-sm);
    transition: all 0.2s;
  }

  #dev-toggle:hover { border-color: var(--peach); color: var(--peach); }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(14px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .fade-up { animation: fadeUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) both; }
  .d1 { animation-delay: 0.05s; }
  .d2 { animation-delay: 0.12s; }
  .d3 { animation-delay: 0.19s; }
  .d4 { animation-delay: 0.26s; }
</style>
</head>
<body>

<!-- SETUP -->
<div id="setup-screen">
  <div class="app-wordmark fade-up">
    Rise
    <span>Wake with intention</span>
  </div>

  <div class="clock-orb-wrap fade-up d1">
    <div class="orb-ring"></div>
    <div class="orb-ring"></div>
    <div class="orb-ring"></div>
    <div class="orb-core">
      <div class="clock-display" id="live-clock">--:--</div>
      <div class="clock-ampm" id="live-ampm">--</div>
    </div>
  </div>

  <div class="clock-date-label fade-up d2" id="live-date">‚Äî</div>

  <div class="setup-card fade-up d3">
    <div id="success-banner" class="success-banner">
      <span>üåø</span> Well done! Your next alarm is set.
    </div>

    <div class="field-group">
      <label class="field-label" for="alarm-time">Wake time</label>
      <input type="time" class="time-input" id="alarm-time" value="07:00">
    </div>

    <div class="toggle-row">
      <div>
        <div class="toggle-name">Alarm enabled</div>
        <div class="toggle-sub" id="alarm-status-sub">Off ‚Äî won't trigger</div>
      </div>
      <button class="pill-toggle" id="alarm-toggle" onclick="toggleAlarm()" aria-label="Toggle alarm"></button>
    </div>

    <div class="next-alarm-chip" id="next-alarm-display">
      <span>üïê</span> Set a time to schedule your alarm
    </div>

    <button class="btn btn-primary fade-up d4" onclick="testAlarmIn5s()">
      Try it now ¬∑ 5 second test
    </button>
    <button class="btn btn-secondary" onclick="saveSettings()">
      Save settings
    </button>
  </div>
</div>

<!-- ALARM OVERLAY -->
<div id="alarm-overlay">
  <div class="alarm-topbar">
    <div class="alarm-pill">
      <div class="alarm-dot"></div>
      Wake time
    </div>
    <div style="display:flex; align-items:center; gap:1.25rem;">
      <div class="step-track">
        <div class="step-seg" id="dot-0"></div>
        <div class="step-seg" id="dot-1"></div>
      </div>
      <div class="sound-badge">
        <div class="sound-dot" id="sound-dot"></div>
        <span id="sound-label">Silent</span>
      </div>
    </div>
  </div>

  <div class="alarm-content">

    <!-- READING -->
    <div id="reading-step">
      <div class="eyebrow">Step 1 of 2 ¬∑ Read</div>
      <h1 class="passage-title" id="passage-title"></h1>
      <p class="passage-subtitle" id="passage-subtitle"></p>
      <div class="passage-body" id="passage-body"></div>

      <div class="dwell-section">
        <div class="dwell-top">
          <div class="dwell-label">Reading progress</div>
          <div class="dwell-timer" id="dwell-timer">25s remaining</div>
        </div>
        <div class="dwell-track">
          <div class="dwell-fill" id="dwell-bar"></div>
        </div>
        <button class="btn btn-primary" id="start-quiz-btn" onclick="startQuiz()" disabled>
          I've read this ‚Äî start the quiz
        </button>
      </div>
    </div>

    <!-- QUIZ -->
    <div id="quiz-step" style="display:none">
      <div class="eyebrow sage">Step 2 of 2 ¬∑ Quiz</div>
      <h1 class="quiz-headline">Quick check-in</h1>
      <p class="quiz-sub" id="quiz-passage-ref"></p>

      <div class="result-card" id="quiz-result">
        <div class="result-icon"></div>
        <div class="result-text"></div>
      </div>

      <div id="questions-container"></div>

      <button class="btn btn-primary" id="submit-btn" onclick="submitQuiz()" style="margin-top:0.5rem">
        Submit answers
      </button>
      <button class="btn btn-secondary" id="retry-btn" onclick="retryQuiz()" style="display:none; margin-top:0.5rem">
        Try again
      </button>
      <button class="btn btn-success" id="dismiss-btn" onclick="dismissAlarm()" style="display:none; margin-top:0.5rem">
        ‚úì Good morning ‚Äî dismiss alarm
      </button>
    </div>

  </div>
</div>

<!-- INACTIVITY TOAST -->
<div class="inactivity-toast" id="inactivity-toast">
  <span>üîî</span> Alarm resuming if you step away‚Ä¶
</div>

<!-- DEV PANEL -->
<button id="dev-toggle" onclick="toggleDevPanel()">Dev</button>
<div id="dev-panel">
  <h4>Dev Panel</h4>
  <div class="dev-row"><span>State</span><span class="dev-val" id="dp-state">IDLE</span></div>
  <div class="dev-row"><span>Sound playing</span><span class="dev-val warm" id="dp-sound">false</span></div>
  <div class="dev-row"><span>Inactivity (s)</span><span class="dev-val amber" id="dp-inactive">0</span></div>
  <div class="dev-row"><span>Resume in (s)</span><span class="dev-val warm" id="dp-resume">‚Äî</span></div>
  <div class="dev-row"><span>Last activity</span><span class="dev-val" id="dp-activity">‚Äî</span></div>
  <div class="dev-row"><span>Dwell (s)</span><span class="dev-val" id="dp-dwell">0</span></div>
  <div class="dev-row"><span>Quiz score</span><span class="dev-val" id="dp-score">‚Äî</span></div>
</div>

<script>
const PASSAGES = [
  {
    id: "stoic-morning",
    title: "The Stoic Morning",
    subtitle: "On purposeful beginnings",
    body: `<p>Marcus Aurelius began each day with a discipline that modern life rarely demands: before he spoke to anyone, before he opened correspondence, before he faced the thousand demands of ruling an empire, he turned inward. He reminded himself that the day ahead would be difficult. People would be frustrating. Plans would fail. And he accepted this‚Äînot with resignation, but with resolve.</p>
<p>The Stoics understood something that neuroscience now confirms: the first moments of wakefulness shape the cognitive and emotional register of the entire day. How you transition from sleep to consciousness is not a passive event. It is a practice, and like all practices, it can be done well or poorly.</p>
<p>Waking up deliberately means asking: what do I intend to do today, and why does it matter? It means treating the morning not as an obstacle between you and productivity, but as the very ground on which productivity is built. You cannot sprint well from a stumbling start.</p>
<p>The alarm that wrenches you from sleep and sends you fumbling for silence is not a neutral tool. It trains a reflex: resistance to awakening. Resistance to the day. The antidote is not gentler sounds or gradual light‚Äîit is engagement. Wake with a question, a task, a reason. Let the mind have something to bite into before the body has finished complaining.</p>`,
    questions: [
      { id:"q1", prompt:"What did Marcus Aurelius do before engaging with others each morning?", options:["Read correspondence from senators","Turned inward and reflected on the day","Exercised for one hour","Reviewed military reports"], correct:1 },
      { id:"q2", prompt:"According to the passage, what does neuroscience confirm about the Stoic view?", options:["That meditation cures anxiety","That morning routines are overrated","That the first moments of wakefulness shape the rest of the day","That sleep duration is what matters most"], correct:2 },
      { id:"q3", prompt:"What reflex does the passage say a standard alarm trains?", options:["Gratitude for a new day","Resistance to awakening","Excitement to start work","Dependence on caffeine"], correct:1 },
      { id:"q4", prompt:"What does the author suggest is the antidote to a poor waking reflex?", options:["Gentler alarm sounds","Gradual light exposure","A longer sleep schedule","Engagement ‚Äî a question or task to bite into"], correct:3 },
      { id:"q5", prompt:"The phrase 'you cannot sprint well from a stumbling start' illustrates what idea?", options:["Athletic training principles","That the morning sets the tone for productivity","The dangers of rushing","That Stoics valued physical fitness"], correct:1 }
    ]
  },
  {
    id: "deep-work",
    title: "The Architecture of Attention",
    subtitle: "On protecting your cognitive resources",
    body: `<p>There is a resource more finite than time and more renewable than money, and we squander it by the hour. Attention‚Äîfocused, undivided, sustained attention‚Äîis the substrate of all meaningful work. Without it, even the most talented person produces only the shallow simulacrum of their potential.</p>
<p>Cal Newport calls it "deep work": the ability to focus without distraction on a cognitively demanding task. He argues, compellingly, that this capacity is becoming both increasingly rare and increasingly valuable in our distracted economy. The people who cultivate it will disproportionately produce the things that matter.</p>
<p>But attention is not just about what we exclude‚Äîit's about the architecture of our days. Research by cognitive scientists shows that willpower and focus deplete with use. Every decision, every interruption, every context switch draws from the same reservoir. By afternoon, most knowledge workers are operating on fumes without knowing it.</p>
<p>This is why the morning is sacred. Before the inbox opens, before Slack pings, before the day's entropy accumulates, there exists a window of maximal cognitive capacity. The question is not whether you have this window‚Äîyou do‚Äîbut whether you spend it on your most important work or surrender it to reactive tasks that feel urgent but aren't.</p>
<p>Guarding your morning is not selfishness. It is the precondition of contribution.</p>`,
    questions: [
      { id:"q1", prompt:"What does the author describe as more finite than time?", options:["Money","Sleep","Attention","Willpower"], correct:2 },
      { id:"q2", prompt:"Cal Newport's concept of 'deep work' refers to what?", options:["Working late into the night","Focusing without distraction on cognitively demanding tasks","Collaborating deeply with a team","Meditating before starting work"], correct:1 },
      { id:"q3", prompt:"What do cognitive scientists say happens to willpower and focus throughout the day?", options:["They increase with practice","They remain stable if you eat well","They deplete with use","They peak mid-afternoon"], correct:2 },
      { id:"q4", prompt:"Why does the author say the morning is 'sacred'?", options:["It is the quietest time of day","It is when creativity is highest","It represents a window of maximal cognitive capacity before entropy accumulates","Mornings are culturally significant"], correct:2 },
      { id:"q5", prompt:"The author argues that guarding your morning is:", options:["A luxury only available to the wealthy","Selfish but necessary","The precondition of contribution","Incompatible with having a family"], correct:2 }
    ]
  },
  {
    id: "habit-loop",
    title: "The Loop That Runs You",
    subtitle: "On understanding behavioral automation",
    body: `<p>Most of what you do today, you will not decide to do. You will simply do it. Neuroscientists estimate that roughly 40‚Äì45% of our daily actions are habits‚Äîbehavioral routines so deeply grooved into neural pathways that they execute without conscious deliberation. You are, in large measure, the sum of your automated responses.</p>
<p>Charles Duhigg identified the mechanism: every habit runs on a loop of cue, routine, and reward. The cue triggers the behavior. The routine executes. The reward teaches the brain that this loop is worth remembering. Over time, the routine becomes automatic. The brain barely has to show up.</p>
<p>This is efficient. The brain conserves energy by offloading repetitive tasks to the basal ganglia‚Äîa primitive region that operates below conscious awareness. But efficiency is a double-edged tool. The same mechanism that automates your morning run also automates your reach for the phone the moment you feel bored.</p>
<p>The critical insight is this: habits cannot be deleted, only replaced. To change a behavior, you must keep the cue and the reward but insert a new routine. The snooze reflex, for instance, has a cue (the alarm), a routine (pressing snooze), and a reward (brief relief from the discomfort of waking). Replace the routine‚Äîmake getting up immediately the path to that relief‚Äîand the habit rewires.</p>
<p>What you do in the first moments after waking is one of the highest-leverage habits in your life, because it sets the frame for everything that follows.</p>`,
    questions: [
      { id:"q1", prompt:"According to neuroscientists, what percentage of daily actions are habits?", options:["About 10‚Äì15%","About 25‚Äì30%","About 40‚Äì45%","About 60‚Äì70%"], correct:2 },
      { id:"q2", prompt:"What three components make up Duhigg's habit loop?", options:["Trigger, response, outcome","Cue, routine, reward","Stimulus, behavior, consequence","Signal, action, result"], correct:1 },
      { id:"q3", prompt:"Which brain region handles automated, habitual behaviors?", options:["The prefrontal cortex","The hippocampus","The amygdala","The basal ganglia"], correct:3 },
      { id:"q4", prompt:"According to the passage, habits cannot be deleted ‚Äî they can only be:", options:["Suppressed through willpower","Replaced by inserting a new routine","Removed through therapy","Overridden permanently by conscious choice"], correct:1 },
      { id:"q5", prompt:"What does the author identify as one of the highest-leverage habits in your life?", options:["Your evening wind-down routine","What you eat for breakfast","What you do in the first moments after waking","How you structure your workday"], correct:2 }
    ]
  }
];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const AppState = { IDLE:'IDLE', RINGING:'RINGING', READING:'READING', QUIZ:'QUIZ', UNLOCKED:'UNLOCKED' };

let state = {
  app: AppState.IDLE,
  alarmEnabled: false,
  alarmTime: '07:00',
  alarmPlaying: false,
  lastActivity: Date.now(),
  inactivitySeconds: 0,
  dwellSeconds: 0,
  dwellComplete: false,
  currentPassageIdx: 0,
  shuffledQuestions: [],
  userAnswers: {},
  quizSubmitted: false,
  quizPassed: false,
};

const INACTIVITY_THRESHOLD = 60;
const DWELL_REQUIRED = 25;

// ‚îÄ‚îÄ AUDIO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let audioCtx = null;
let alarmLoopTimeout = null;

function getCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

function startAlarmSound() {
  if (state.alarmPlaying) return;
  state.alarmPlaying = true;
  loopBeep();
  updateSoundUI();
}

function loopBeep() {
  if (!state.alarmPlaying) return;
  playChime();
  alarmLoopTimeout = setTimeout(loopBeep, 2200);
}

function playChime() {
  if (!state.alarmPlaying) return;
  const ctx = getCtx();
  [[0, 660, 0.16], [0.24, 528, 0.12], [0.48, 660, 0.08]].forEach(([delay, freq, vol]) => {
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    const t = ctx.currentTime + delay;
    osc.type = 'sine';
    osc.frequency.value = freq;
    gain.gain.setValueAtTime(0, t);
    gain.gain.linearRampToValueAtTime(vol, t + 0.07);
    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.55);
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start(t);
    osc.stop(t + 0.6);
  });
}

function stopAlarmSound() {
  state.alarmPlaying = false;
  clearTimeout(alarmLoopTimeout);
  updateSoundUI();
}

function updateSoundUI() {
  const dot = document.getElementById('sound-dot');
  const label = document.getElementById('sound-label');
  if (state.alarmPlaying) {
    dot.classList.add('playing');
    label.textContent = 'Chiming';
  } else {
    dot.classList.remove('playing');
    label.textContent = 'Silent';
  }
  updateDevPanel();
}

// ‚îÄ‚îÄ INACTIVITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let inactivityInterval = null;

function startInactivityTracking() {
  clearInterval(inactivityInterval);
  state.lastActivity = Date.now();
  ['mousemove','keydown','click','touchstart','scroll','touchmove'].forEach(e =>
    document.addEventListener(e, onActivity, { passive: true })
  );
  inactivityInterval = setInterval(() => {
    if (state.app === AppState.IDLE || state.app === AppState.UNLOCKED) return;
    const elapsed = (Date.now() - state.lastActivity) / 1000;
    state.inactivitySeconds = Math.floor(elapsed);
    const toast = document.getElementById('inactivity-toast');
    elapsed > 45 && elapsed < INACTIVITY_THRESHOLD ? toast.classList.add('show') : toast.classList.remove('show');
    if (elapsed >= INACTIVITY_THRESHOLD && !state.alarmPlaying) startAlarmSound();
    updateDevPanel();
  }, 500);
}

function stopInactivityTracking() {
  clearInterval(inactivityInterval);
  ['mousemove','keydown','click','touchstart','scroll','touchmove'].forEach(e =>
    document.removeEventListener(e, onActivity)
  );
}

function onActivity() {
  state.lastActivity = Date.now();
  document.getElementById('inactivity-toast').classList.remove('show');
  if (state.alarmPlaying && state.app !== AppState.IDLE) stopAlarmSound();
}

// ‚îÄ‚îÄ DWELL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let dwellInterval = null;

function startDwellTimer() {
  state.dwellSeconds = 0;
  state.dwellComplete = false;
  clearInterval(dwellInterval);
  dwellInterval = setInterval(() => {
    state.dwellSeconds++;
    const pct = Math.min(100, (state.dwellSeconds / DWELL_REQUIRED) * 100);
    const bar = document.getElementById('dwell-bar');
    bar.style.width = pct + '%';
    const remaining = Math.max(0, DWELL_REQUIRED - state.dwellSeconds);
    const timerEl = document.getElementById('dwell-timer');
    if (state.dwellSeconds >= DWELL_REQUIRED && !state.dwellComplete) {
      state.dwellComplete = true;
      bar.classList.add('complete');
      timerEl.textContent = 'Ready ‚úì';
      timerEl.style.color = 'var(--sage)';
      document.getElementById('start-quiz-btn').disabled = false;
      clearInterval(dwellInterval);
    } else if (remaining > 0) {
      timerEl.textContent = `${remaining}s remaining`;
    }
    updateDevPanel();
  }, 1000);
}

// ‚îÄ‚îÄ ALARM CHECK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let alarmCheckInterval = null;
let testTimeout = null;

function startAlarmCheck() {
  clearInterval(alarmCheckInterval);
  alarmCheckInterval = setInterval(() => {
    if (!state.alarmEnabled || state.app !== AppState.IDLE) return;
    const now = new Date();
    const hhmm = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    if (hhmm === state.alarmTime && now.getSeconds() < 10) triggerAlarm();
  }, 5000);
}

function triggerAlarm() {
  if (state.app !== AppState.IDLE) return;
  state.app = AppState.RINGING;
  getCtx().resume().then(() => { startAlarmSound(); showWakeFlow(); startInactivityTracking(); });
}

function testAlarmIn5s() {
  clearTimeout(testTimeout);
  const btn = document.querySelector('[onclick="testAlarmIn5s()"]');
  btn.textContent = 'Starting in 5s‚Ä¶';
  btn.disabled = true;
  testTimeout = setTimeout(() => {
    btn.textContent = 'Try it now ¬∑ 5 second test';
    btn.disabled = false;
    triggerAlarm();
  }, 5000);
}

// ‚îÄ‚îÄ WAKE FLOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showWakeFlow() {
  state.currentPassageIdx = Math.floor(Math.random() * PASSAGES.length);
  const p = PASSAGES[state.currentPassageIdx];

  document.getElementById('setup-screen').style.display = 'none';
  document.getElementById('alarm-overlay').classList.add('active');
  document.getElementById('passage-title').textContent = p.title;
  document.getElementById('passage-subtitle').textContent = p.subtitle;
  document.getElementById('passage-body').innerHTML = p.body;
  document.getElementById('reading-step').style.display = 'block';
  document.getElementById('quiz-step').style.display = 'none';
  document.getElementById('start-quiz-btn').disabled = true;
  document.getElementById('dwell-bar').style.width = '0%';
  document.getElementById('dwell-bar').classList.remove('complete');
  document.getElementById('dwell-timer').textContent = `${DWELL_REQUIRED}s remaining`;
  document.getElementById('dwell-timer').style.color = '';

  setAppState(AppState.READING);
  startDwellTimer();
  updateDots();

  if ('Notification' in window && Notification.permission !== 'denied') {
    Notification.requestPermission().then(perm => {
      if (perm === 'granted') new Notification('üåÖ Rise ‚Äî Wake time', { body: 'Read and answer 5 questions to dismiss.' });
    });
  }

  history.pushState({ alarmActive: true }, '');
  window.onpopstate = () => { if (state.app !== AppState.IDLE) history.pushState({ alarmActive: true }, ''); };
}

function startQuiz() {
  setAppState(AppState.QUIZ);
  const p = PASSAGES[state.currentPassageIdx];
  state.shuffledQuestions = shuffleArray(p.questions.map(q => ({ ...q, shuffledOptions: shuffleOptions(q.options, q.correct) })));
  state.userAnswers = {};
  state.quizSubmitted = false;
  state.quizPassed = false;

  document.getElementById('reading-step').style.display = 'none';
  document.getElementById('quiz-step').style.display = 'block';
  document.getElementById('quiz-passage-ref').textContent = `Based on: "${p.title}"`;
  const rc = document.getElementById('quiz-result');
  rc.className = 'result-card';
  rc.style.display = 'none';
  document.getElementById('submit-btn').style.display = 'block';
  document.getElementById('retry-btn').style.display = 'none';
  document.getElementById('dismiss-btn').style.display = 'none';

  renderQuiz();
  updateDots();
  clearInterval(dwellInterval);
}

function shuffleArray(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function shuffleOptions(options, correctIndex) {
  const indexed = options.map((text, i) => ({ text, isCorrect: i === correctIndex }));
  const shuffled = shuffleArray(indexed);
  return { texts: shuffled.map(o => o.text), newCorrectIndex: shuffled.findIndex(o => o.isCorrect) };
}

const LETTERS = ['A','B','C','D'];

function renderQuiz() {
  const container = document.getElementById('questions-container');
  container.innerHTML = '';
  state.shuffledQuestions.forEach((q, qi) => {
    const card = document.createElement('div');
    card.className = 'question-card';
    card.id = `qcard-${qi}`;

    const num = document.createElement('div');
    num.className = 'question-num';
    num.textContent = `Question ${qi + 1} of 5`;
    card.appendChild(num);

    const prompt = document.createElement('div');
    prompt.className = 'question-prompt';
    prompt.textContent = q.prompt;
    card.appendChild(prompt);

    q.shuffledOptions.texts.forEach((opt, oi) => {
      const btn = document.createElement('button');
      btn.className = 'option-btn';
      btn.id = `opt-${qi}-${oi}`;
      btn.onclick = () => selectOption(qi, oi);
      const letter = document.createElement('div');
      letter.className = 'option-letter';
      letter.textContent = LETTERS[oi];
      const text = document.createElement('span');
      text.textContent = opt;
      btn.appendChild(letter);
      btn.appendChild(text);
      card.appendChild(btn);
    });

    container.appendChild(card);
  });
  updateDevPanel();
}

function selectOption(qi, oi) {
  if (state.quizSubmitted) return;
  state.userAnswers[qi] = oi;
  state.shuffledQuestions[qi].shuffledOptions.texts.forEach((_, i) => {
    const btn = document.getElementById(`opt-${qi}-${i}`);
    btn.className = 'option-btn' + (i === oi ? ' selected' : '');
  });
}

function submitQuiz() {
  const unanswered = state.shuffledQuestions.findIndex((_, i) => state.userAnswers[i] === undefined);
  if (unanswered >= 0) {
    const card = document.getElementById(`qcard-${unanswered}`);
    card.scrollIntoView({ behavior:'smooth', block:'center' });
    card.style.boxShadow = '0 0 0 2px var(--peach)';
    setTimeout(() => card.style.boxShadow = '', 1500);
    return;
  }

  state.quizSubmitted = true;
  let score = 0;

  state.shuffledQuestions.forEach((q, qi) => {
    const userAns = state.userAnswers[qi];
    const correct = q.shuffledOptions.newCorrectIndex;
    const isRight = userAns === correct;
    if (isRight) score++;
    document.getElementById(`qcard-${qi}`).className = 'question-card ' + (isRight ? 'correct' : 'incorrect');
    q.shuffledOptions.texts.forEach((_, oi) => {
      const btn = document.getElementById(`opt-${qi}-${oi}`);
      btn.disabled = true;
      btn.className = 'option-btn';
      if (oi === correct) btn.classList.add('correct-ans');
      else if (oi === userAns && !isRight) btn.classList.add('wrong-ans');
    });
  });

  const rc = document.getElementById('quiz-result');
  const icon = rc.querySelector('.result-icon');
  const text = rc.querySelector('.result-text');

  if (score === 5) {
    state.quizPassed = true;
    setAppState(AppState.UNLOCKED);
    rc.className = 'result-card pass';
    icon.textContent = 'üåø';
    text.textContent = "Perfect ‚Äî 5/5. You're fully awake. Dismiss your alarm when ready.";
    document.getElementById('submit-btn').style.display = 'none';
    document.getElementById('dismiss-btn').style.display = 'block';
    stopAlarmSound();
  } else {
    rc.className = 'result-card fail';
    icon.textContent = 'üîÑ';
    text.textContent = `${score} of 5 correct. Give it another read and try again ‚Äî you've got this.`;
    document.getElementById('submit-btn').style.display = 'none';
    document.getElementById('retry-btn').style.display = 'block';
  }

  rc.scrollIntoView({ behavior: 'smooth' });
  updateDevPanel();
}

function retryQuiz() {
  state.userAnswers = {};
  state.quizSubmitted = false;
  const p = PASSAGES[state.currentPassageIdx];
  state.shuffledQuestions = shuffleArray(p.questions.map(q => ({ ...q, shuffledOptions: shuffleOptions(q.options, q.correct) })));
  const rc = document.getElementById('quiz-result');
  rc.className = 'result-card';
  rc.style.display = 'none';
  document.getElementById('retry-btn').style.display = 'none';
  document.getElementById('submit-btn').style.display = 'block';
  renderQuiz();
}

function dismissAlarm() {
  stopAlarmSound();
  stopInactivityTracking();
  clearInterval(dwellInterval);
  setAppState(AppState.IDLE);
  document.getElementById('alarm-overlay').classList.remove('active');
  document.getElementById('setup-screen').style.display = 'flex';
  document.getElementById('inactivity-toast').classList.remove('show');
  const banner = document.getElementById('success-banner');
  banner.style.display = 'flex';
  setTimeout(() => banner.style.display = 'none', 8000);
  updateNextAlarmDisplay();
  saveSettings();
}

function updateDots() {
  const isQuiz = state.app === AppState.QUIZ || state.app === AppState.UNLOCKED;
  document.getElementById('dot-0').className = 'step-seg ' + (isQuiz ? 'done' : 'active');
  document.getElementById('dot-1').className = 'step-seg ' + (state.app === AppState.UNLOCKED ? 'done' : isQuiz ? 'active' : '');
}

function setAppState(s) { state.app = s; updateDevPanel(); }

function updateDevPanel() {
  const elapsed = (Date.now() - state.lastActivity) / 1000;
  const resumeIn = Math.max(0, INACTIVITY_THRESHOLD - elapsed);
  document.getElementById('dp-state').textContent = state.app;
  document.getElementById('dp-sound').textContent = String(state.alarmPlaying);
  document.getElementById('dp-inactive').textContent = state.inactivitySeconds + 's';
  document.getElementById('dp-resume').textContent = state.app !== AppState.IDLE ? resumeIn.toFixed(1) + 's' : '‚Äî';
  document.getElementById('dp-activity').textContent = new Date(state.lastActivity).toLocaleTimeString();
  document.getElementById('dp-dwell').textContent = state.dwellSeconds + 's';
  document.getElementById('dp-score').textContent = state.quizSubmitted
    ? Object.entries(state.userAnswers).filter(([qi, ans]) => ans === state.shuffledQuestions[+qi]?.shuffledOptions?.newCorrectIndex).length + '/5'
    : '‚Äî';
}

function toggleDevPanel() {
  const p = document.getElementById('dev-panel');
  p.style.display = p.style.display === 'none' ? 'block' : 'none';
}

// ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadSettings() {
  try {
    const s = JSON.parse(localStorage.getItem('rise_alarm') || '{}');
    if (s.alarmTime) state.alarmTime = s.alarmTime;
    if (s.alarmEnabled !== undefined) state.alarmEnabled = s.alarmEnabled;
    document.getElementById('alarm-time').value = state.alarmTime;
    updateToggleUI();
    updateNextAlarmDisplay();
  } catch(e) {}
}

function saveSettings() {
  state.alarmTime = document.getElementById('alarm-time').value;
  localStorage.setItem('rise_alarm', JSON.stringify({ alarmTime: state.alarmTime, alarmEnabled: state.alarmEnabled }));
  updateNextAlarmDisplay();
}

function toggleAlarm() {
  state.alarmEnabled = !state.alarmEnabled;
  updateToggleUI();
  saveSettings();
}

function updateToggleUI() {
  document.getElementById('alarm-toggle').className = 'pill-toggle' + (state.alarmEnabled ? ' on' : '');
  document.getElementById('alarm-status-sub').textContent = state.alarmEnabled ? "On ‚Äî will trigger at set time" : "Off ‚Äî won't trigger";
}

function updateNextAlarmDisplay() {
  const el = document.getElementById('next-alarm-display');
  if (!state.alarmEnabled) { el.innerHTML = '<span>üí§</span> Alarm disabled'; return; }
  const [h, m] = state.alarmTime.split(':').map(Number);
  const now = new Date();
  const alarm = new Date();
  alarm.setHours(h, m, 0, 0);
  if (alarm <= now) alarm.setDate(alarm.getDate() + 1);
  const diff = alarm - now;
  const hrs = Math.floor(diff / 3600000);
  const mins = Math.floor((diff % 3600000) / 60000);
  const label = `${h % 12 || 12}:${String(m).padStart(2,'0')} ${h >= 12 ? 'pm' : 'am'}`;
  el.innerHTML = `<span>üåÖ</span> Next alarm: ${label} ¬∑ in ${hrs}h ${mins}m`;
}

// ‚îÄ‚îÄ LIVE CLOCK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startLiveClock() {
  setInterval(() => {
    const now = new Date();
    const h = now.getHours();
    const m = String(now.getMinutes()).padStart(2,'0');
    document.getElementById('live-clock').textContent = `${h % 12 || 12}:${m}`;
    document.getElementById('live-ampm').textContent = h >= 12 ? 'PM' : 'AM';
    document.getElementById('live-date').textContent = now.toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric' });
  }, 1000);
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('alarm-time').addEventListener('change', saveSettings);
document.addEventListener('click', () => { if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); }, { once: true });

loadSettings();
startLiveClock();
startAlarmCheck();
</script>
</body>
</html>
